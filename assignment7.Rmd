---
title: "assignment7"
author: "Subhasree Samanta"
date: "November 6, 2016"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(stringr)
library(choroplethr)
library(choroplethrMaps)
library(ggthemes)
```

    
    
```{r, first dataset}
mortality <- read.csv("data/xmart.csv")

##Removing extra spaces
mortality[,3] <-gsub(" ","", mortality[,3]) 

##Renaming colnames for later
names(mortality) <- c("Country","Year","mm_ratio","births_attended")

##Extracting bounds
mortality$lower_bound <- str_split_fixed(str_extract(mortality[,3],"\\[[ 0-9 -]+\\]"), "-", 2)[,1]
mortality$upper_bound <- str_split_fixed(str_extract(mortality[,3],"\\[[ 0-9 -]+\\]"), "-", 2)[,2]

##Removing brackets
mortality$lower_bound <- as.integer(gsub("\\[", "", mortality$lower_bound))
mortality$upper_bound <- as.integer(gsub("\\]","", mortality$upper_bound))

##Removing bounds from col3
mortality[,3] <- as.integer(gsub("\\[[ 0-9 -]+\\]", "", mortality[,3]))
```

```{r, second dataset}
gni <- read.csv("data/WHS9_93.csv", skip=1, as.is = TRUE, check.names = FALSE)

##Removing extra spaces from & changing class of 2013 to integer
gni[,2] <-as.integer(gsub(" ","", gni[,2]))

##Tidying data: Using gather to have one entry per country per year
gni <- gni %>%
  gather(Year, income, 2:25)
```

```{r, merging data}

##Retaining only rows which have per capita income
gni1 <- gni %>% filter(!is.na(gni$income))

##Merging the two files, retaining only rows which have per capita income & maternal mortality or attended births
merged <- merge(gni,mortality) %>%
  filter(!is.na(income)) %>%
  filter(!is.na(mm_ratio) | !is.na(births_attended))

```

- Make a two polished  and informative graphs, one relating income to maternal mortality and the other relating income to percentage attended births
```{r, graphs}
## Box plots?
plot1 <- merged %>%
  ggplot(.,aes(x=income, y=mm_ratio)) + geom_point() + geom_line() + theme_minimal() + scale_color_ptol() + labs(title ="Title", y="y", x="x", color = "color")
plot1


```


```{r saving file}
write_csv(merged, "data/income.mortality.csv")

```
- Use the country_choropleth() function in the choroplethr package to make a world map of maternal mortality, using the most recent year for each country in the merged dataset you created. The defaults of the function will be fine; no need to tune up the plot. You can read the help file to see how the data must be formatted; you may need to rename the countries from the dataset that you've created.
- All of your steps, other than downloading the files, should be contained in a single R Markdown file that will run in the repo directory. Be sure to describe your steps

```{r, choropleth}

## Using aggregate to use most recent year for each country
choromerge <- merge(merged,aggregate(Year ~ Country, merged, max))

## Changing region names to lower to match region requirements for choropleth
choromerge[,1] <- str_to_lower(choromerge[,1])

##Checking which countries do not match the proper format
data(country.regions)
missing <- anti_join(choromerge, country.regions, by =c("Country" = "region"))


##Choropleth
choromerge %>%
  dplyr::rename(value = mm_ratio, region = Country) %>%
  country_choropleth(title ="title")




```
